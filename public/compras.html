<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Criar Lista de Compras</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .item-lista { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .controles { display: flex; align-items: center; gap: 10px; }
        button { cursor: pointer; border: none; border-radius: 4px; padding: 5px 10px; }
        .btn-qtd { background: #007bff; color: white; font-weight: bold; }
        .btn-salvar { background: #28a745; color: white; width: 100%; padding: 15px; margin-top: 20px; font-size: 16px; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <button onclick="window.location.href='dashboard.html'">← Voltar</button>
    <h2>Nova Lista de Compras</h2>
    
    <input type="text" id="lista-nome" placeholder="Ex: Compras do Mês" style="width: 100%; margin-bottom: 10px;">
    <input type="date" id="lista-data" style="width: 100%; margin-bottom: 20px;">

    <h3>Selecione os Produtos</h3>
    <div id="recycler-produtos">
        </div>

    <button class="btn-salvar" onclick="salvarLista()">Salvar Lista de Compras</button>
</div>

<script>
    const token = localStorage.getItem('token');
    let produtosDisponiveis = [];
    let carrinho = {}; // Guarda { produtoId: quantidade }

    async function carregarProdutos() {
        const res = await fetch('/products', { headers: { 'Authorization': 'Bearer ' + token } });
        produtosDisponiveis = await res.json();
        renderizar();
    }

    function alterarQtd(id, delta) {
        const atual = carrinho[id] || 0;
        const novaQtd = Math.max(0, atual + delta);
        if (novaQtd === 0) delete carrinho[id];
        else carrinho[id] = novaQtd;
        renderizar();
    }

    function renderizar() {
        const container = document.getElementById('recycler-produtos');
        container.innerHTML = '';

        produtosDisponiveis.forEach(p => {
            const qtd = carrinho[p._id] || 0;
            container.innerHTML += `
                <div class="item-lista">
                    <div>
                        <strong>${p.nome}</strong><br>
                        <small>R$ ${p.preco}</small>
                    </div>
                    <div class="controles">
                        <button class="btn-qtd" onclick="alterarQtd('${p._id}', -1)">-</button>
                        <span>${qtd}</span>
                        <button class="btn-qtd" onclick="alterarQtd('${p._id}', 1)">+</button>
                    </div>
                </div>
            `;
        });
    }

    async function salvarLista() {
        const nome = document.getElementById('lista-nome').value;
        const data = document.getElementById('lista-data').value;
        
        // Mapeia o carrinho para o formato que o banco espera
        const itens = Object.keys(carrinho).map(id => {
            const p = produtosDisponiveis.find(prod => prod._id === id);
            return { produtoId: id, nome: p.nome, quantidade: carrinho[id] };
        });

        if (!nome || !data || itens.length === 0) return alert("Preencha tudo e adicione itens!");

        const res = await fetch('/shopping-lists', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ nome, data, itens })
        });

        if (res.ok) {
            alert("Lista salva com sucesso!");
            window.location.href = 'dashboard.html';
        }
    }

    carregarProdutos();
</script>
</body>
</html>
