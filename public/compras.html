<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Lista de Compras</title>
    <style>
        /* Padronização com o Dashboard */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f0f2f5; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; /* Permite scroll se a lista for longa */
            min-height: 100vh; 
            margin: 0; 
            padding: 20px;
            box-sizing: border-box;
        }

        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            width: 100%;
            max-width: 450px; 
        }

        h2 { margin-bottom: 20px; color: #1c1e21; font-size: 24px; text-align: center; }
        h3 { color: #4b4f56; font-size: 18px; margin-top: 25px; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }

        .btn-voltar {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Inputs padronizados */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #606770; font-size: 14px; }
        input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box;
            font-size: 16px;
        }

        /* Lista de Produtos (RecyclerView Style) */
        #recycler-produtos { margin-top: 15px; }

        .item-produto {
            background: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid #6f42c1; /* Roxo para diferenciar da tela de cadastro */
        }

        .info-produto strong { color: #333; display: block; }
        .info-produto small { color: #28a745; font-weight: 600; }

        /* Controles de Quantidade */
        .controles { display: flex; align-items: center; gap: 12px; }
        .btn-qtd { 
            background: #e4e6eb; 
            border: none; 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-weight: bold; 
            transition: 0.2s;
        }
        .btn-qtd:hover { background: #d8dadf; }
        .qtd-numero { font-weight: bold; min-width: 20px; text-align: center; }

        .btn-salvar { 
            margin-top: 30px; 
            width: 100%; 
            padding: 15px; 
            border: none; 
            background: linear-gradient(135deg, #28a745, #218838); 
            color: white; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 18px;
            font-weight: 600; 
            box-shadow: 0 4px 10px rgba(40,167,69,0.3);
        }
        .btn-salvar:hover { opacity: 0.9; }
    </style>
</head>
<body>

<div class="card">
    <button class="btn-voltar" onclick="window.location.href='dashboard.html'">
        ← Voltar ao Painel
    </button>
    
    <h2>Nova Lista</h2>

    <div class="input-group">
        <label>Nome da Lista</label>
        <input type="text" id="lista-nome" placeholder="Ex: Churrasco de Domingo">
    </div>

    <div class="input-group">
        <label>Data Prevista</label>
        <input type="date" id="lista-data">
    </div>

    <h3>Escolha os itens</h3>
    <div id="recycler-produtos">
        </div>

    <button class="btn-salvar" onclick="salvarLista()">Finalizar e Salvar</button>
</div>

<script>
    const token = localStorage.getItem('token');
    let produtosDisponiveis = [];
    let carrinho = {}; 

    if (!token) window.location.href = "index.html";

    async function carregarProdutos() {
        try {
            const res = await fetch('/products', { 
                headers: { 'Authorization': 'Bearer ' + token } 
            });
            produtosDisponiveis = await res.json();
            renderizar();
        } catch (erro) {
            console.error("Erro ao carregar produtos:", erro);
        }
    }

    function alterarQtd(id, delta) {
        const atual = carrinho[id] || 0;
        const novaQtd = Math.max(0, atual + delta);
        
        if (novaQtd === 0) {
            delete carrinho[id];
        } else {
            carrinho[id] = novaQtd;
        }
        renderizar();
    }

    function renderizar() {
        const container = document.getElementById('recycler-produtos');
        container.innerHTML = '';

        if (produtosDisponiveis.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999;">Cadastre produtos no dashboard primeiro.</p>';
            return;
        }

        produtosDisponiveis.forEach(p => {
            const qtd = carrinho[p._id] || 0;
            container.innerHTML += `
                <div class="item-produto">
                    <div class="info-produto">
                        <strong>${p.nome}</strong>
                        <small>R$ ${Number(p.preco).toFixed(2)}</small>
                    </div>
                    <div class="controles">
                        <button class="btn-qtd" onclick="alterarQtd('${p._id}', -1)">-</button>
                        <span class="qtd-numero">${qtd}</span>
                        <button class="btn-qtd" onclick="alterarQtd('${p._id}', 1)">+</button>
                    </div>
                </div>
            `;
        });
    }

    async function salvarLista() {
        const nome = document.getElementById('lista-nome').value;
        const data = document.getElementById('lista-data').value;
        
        const itens = Object.keys(carrinho).map(id => {
            const p = produtosDisponiveis.find(prod => prod._id === id);
            return { produtoId: id, nome: p.nome, quantidade: carrinho[id] };
        });

        if (!nome || !data || itens.length === 0) {
            return alert("Por favor, preencha o nome, data e selecione ao menos 1 item.");
        }

        try {
            const res = await fetch('/shopping-lists', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                    'Authorization': 'Bearer ' + token 
                },
                body: JSON.stringify({ nome, data, itens })
            });

            if (res.ok) {
                alert("✅ Lista de compras salva com sucesso!");
                window.location.href = 'dashboard.html';
            }
        } catch (erro) {
            alert("Erro ao salvar a lista.");
        }
    }

    carregarProdutos();
</script>
</body>
</html>
